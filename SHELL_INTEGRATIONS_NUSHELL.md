# Shell Integrations (Nushell)

Shell integration setup for Nushell. This generates `~/.shell_integrations.nu` that works on both Linux and macOS.

**For Bash/Zsh or Fish:** See `SHELL_INTEGRATIONS.md` or `SHELL_INTEGRATIONS_FISH.md`

---

## Setup Shell Integrations File

Initialize the shell integrations file with header.

```bash
#!/bin/sh

cat > ~/.shell_integrations.nu << 'EOF'
# Shell Integrations for Nushell
# Generated by init/SHELL_INTEGRATIONS_NUSHELL.md
# Works on Linux and macOS
EOF

echo "✓ Created ~/.shell_integrations.nu"
```

---

## Hook shell integration file

Automatically add sourcing line to Nushell config file.

**Note:** Nushell has two config files:
- `config.nu` - for general configuration
- `env.nu` - for environment variables

We'll add to `config.nu` since most integrations modify the environment.

```bash
#!/bin/sh

# Ensure Nushell config directory exists
mkdir -p ~/.config/nushell

# Hook for config.nu
if [ -f ~/.config/nushell/config.nu ]; then
  if ! grep -q ".shell_integrations.nu" ~/.config/nushell/config.nu; then
    cat >> ~/.config/nushell/config.nu << 'EOF'

# Source shell integrations
if ($env.HOME | path join ".shell_integrations.nu" | path exists) {
  source ~/.shell_integrations.nu
}
EOF
    echo "✓ Added hook to ~/.config/nushell/config.nu"
  else
    echo "⊘ Hook already exists in ~/.config/nushell/config.nu"
  fi
else
  echo "✓ Creating ~/.config/nushell/config.nu with hook"
  cat > ~/.config/nushell/config.nu << 'EOF'
# Source shell integrations
if ($env.HOME | path join ".shell_integrations.nu" | path exists) {
  source ~/.shell_integrations.nu
}
EOF
fi
```

---

## Add Zoxide Integration

Add smart directory jumper (zoxide) integration.

**Prerequisites:** Install zoxide via Homebrew (`brew install zoxide`)

```bash
#!/bin/sh

cat >> ~/.shell_integrations.nu << 'EOF'

# Zoxide - Smart cd replacement
if (which zoxide | is-empty | not) {
  zoxide init nushell | save -f ~/.zoxide.nu
  source ~/.zoxide.nu
}
EOF

echo "✓ Added Zoxide integration to ~/.shell_integrations.nu"
```

---

## Add Starship Prompt Integration

Add Starship prompt integration.

**Prerequisites:** Install starship via Homebrew (`brew install starship`)

```bash
#!/bin/sh

cat >> ~/.shell_integrations.nu << 'EOF'

# Starship - Cross-shell prompt
if (which starship | is-empty | not) {
  $env.STARSHIP_SHELL = "nu"

  def create_left_prompt [] {
    starship prompt --cmd-duration $env.CMD_DURATION_MS $'--status=($env.LAST_EXIT_CODE)'
  }

  def create_right_prompt [] {
    starship prompt --right --cmd-duration $env.CMD_DURATION_MS $'--status=($env.LAST_EXIT_CODE)'
  }

  $env.PROMPT_COMMAND = { || create_left_prompt }
  $env.PROMPT_COMMAND_RIGHT = { || create_right_prompt }
}
EOF

echo "✓ Added Starship integration to ~/.shell_integrations.nu"
```

---

## Add FNM Integration

Add Fast Node Manager (fnm) shell integration.

**Prerequisites:** Install fnm (see README.md "Fast Node Manager" task)

**Note:** fnm doesn't have native Nushell support yet. You may need to manually manage PATH.

```bash
#!/bin/sh

cat >> ~/.shell_integrations.nu << 'EOF'

# FNM - Fast Node Manager
# Note: fnm doesn't have native Nushell support yet
# This adds fnm directory to PATH
if (which fnm | is-empty | not) {
  let fnm_dir = (fnm env --shell bash | lines | find "FNM_DIR" | first | split row "=" | last | str trim -c '"')
  if ($fnm_dir | path exists) {
    $env.PATH = ($env.PATH | prepend ($fnm_dir | path join "aliases" "default" "bin"))
  }
}
EOF

echo "⚠ Added FNM integration to ~/.shell_integrations.nu (limited support)"
```

---

## Add Homebrew Integration

Add Homebrew to PATH (essential on Linux, useful on macOS).

**Prerequisites:** Install Homebrew (see HOMEBREW.md)

```bash
#!/bin/sh

cat >> ~/.shell_integrations.nu << 'EOF'

# Homebrew - Package manager
if ("/home/linuxbrew/.linuxbrew" | path exists) {
  # Linux Homebrew
  $env.PATH = ($env.PATH | prepend "/home/linuxbrew/.linuxbrew/bin")
  $env.HOMEBREW_PREFIX = "/home/linuxbrew/.linuxbrew"
} else if ("/opt/homebrew" | path exists) {
  # macOS Apple Silicon
  $env.PATH = ($env.PATH | prepend "/opt/homebrew/bin")
  $env.HOMEBREW_PREFIX = "/opt/homebrew"
} else if ("/usr/local/Homebrew" | path exists) {
  # macOS Intel
  $env.PATH = ($env.PATH | prepend "/usr/local/bin")
  $env.HOMEBREW_PREFIX = "/usr/local"
}
EOF

echo "✓ Added Homebrew integration to ~/.shell_integrations.nu"
```

---

## Add Rust/Cargo Integration

Add Rust's cargo to PATH.

**Prerequisites:** Install Rustup (see README.md "Rust Toolchain" task)

```bash
#!/bin/sh

cat >> ~/.shell_integrations.nu << 'EOF'

# Rust/Cargo
let cargo_bin = ($env.HOME | path join ".cargo" "bin")
if ($cargo_bin | path exists) {
  $env.PATH = ($env.PATH | prepend $cargo_bin)
}
EOF

echo "✓ Added Rust/Cargo integration to ~/.shell_integrations.nu"
```

---

## Add Go Integration

Add Go binary path.

**Prerequisites:** Install Go via Homebrew (`brew install go`)

```bash
#!/bin/sh

cat >> ~/.shell_integrations.nu << 'EOF'

# Go
let go_bin = ($env.HOME | path join "go" "bin")
if ($go_bin | path exists) {
  $env.PATH = ($env.PATH | prepend $go_bin)
}
EOF

echo "✓ Added Go integration to ~/.shell_integrations.nu"
```

---

## Sourcing the Integration File

The hook task automatically adds sourcing to your Nushell config. If you prefer to add manually:

**Add to `~/.config/nushell/config.nu`:**
```nushell
# Source shell integrations
if ($env.HOME | path join ".shell_integrations.nu" | path exists) {
  source ~/.shell_integrations.nu
}
```

---

## Usage with mx

```bash
# Setup base file
mx -f init/SHELL_INTEGRATIONS_NUSHELL.md "Setup Shell Integrations File"

# Hook into Nushell config
mx -f init/SHELL_INTEGRATIONS_NUSHELL.md "Hook shell integration file"

# Add specific integrations
mx -f init/SHELL_INTEGRATIONS_NUSHELL.md "Add Zoxide Integration"
mx -f init/SHELL_INTEGRATIONS_NUSHELL.md "Add Starship Integration"
mx -f init/SHELL_INTEGRATIONS_NUSHELL.md "Add Homebrew Integration"

# Check what was added
cat ~/.shell_integrations.nu
```

---

## Testing

Verify integrations are working:

```nushell
# Reload your shell
source ~/.config/nushell/config.nu

# Test Zoxide
z --version

# Test Starship (should see prompt change)
# Just observe the prompt

# Test other tools
which zoxide starship
```

---

## Notes

- **Order matters:** Run "Setup Shell Integrations File" first
- **Idempotent:** Safe to re-run tasks (appends to file)
- **Cross-platform:** Works on Linux and macOS
- **Commands checked:** Uses `which <cmd> | is-empty | not` pattern
- **PATH management:** Uses `$env.PATH = ($env.PATH | prepend "/path")`
- **Config locations:** `~/.config/nushell/config.nu` and `~/.config/nushell/env.nu`
- **Limited support:** Some tools don't have native Nushell support yet

---

## Nushell-Specific Features

### Command Existence Check
```nushell
if (which command_name | is-empty | not) {
  # command exists
}
```

### File Existence Check
```nushell
if ("/path/to/file" | path exists) {
  # file exists
}
```

### Path Join
```nushell
let full_path = ($env.HOME | path join "subdir" "file")
```

### Adding to PATH
```nushell
# Prepend to PATH
$env.PATH = ($env.PATH | prepend "/path/to/bin")

# Append to PATH
$env.PATH = ($env.PATH | append "/path/to/bin")
```

### Setting Environment Variables
```nushell
# In config.nu or shell_integrations.nu
$env.MY_VAR = "value"

# In env.nu (preferred for env vars)
$env.MY_VAR = "value"
```

---

## Integration Support Status

| Tool | Support | Notes |
|------|---------|-------|
| Zoxide | ✅ Full | Native `zoxide init nushell` |
| Starship | ✅ Full | Native Nushell support |
| Homebrew | ✅ Manual | PATH/env var management |
| Rust/Cargo | ✅ Manual | PATH management |
| Go | ✅ Manual | PATH management |
| FNM | ⚠️ Limited | No native Nushell support |
| Direnv | ❌ None | No Nushell support yet |
| FZF | ❌ None | No native Nushell integration |

---

## Troubleshooting

**Integration not working:**
- Check if tool is installed: `which <tool>`
- Check if integration file is sourced: `open ~/.config/nushell/config.nu | str contains ".shell_integrations.nu"`
- Reload Nushell: restart terminal or `source ~/.config/nushell/config.nu`

**Duplicate entries:**
- If you re-run tasks, integrations will be appended multiple times
- Either start fresh (`rm ~/.shell_integrations.nu`) or manually edit the file

**PATH not updating:**
- Verify PATH: `$env.PATH`
- Ensure you're modifying `$env.PATH` correctly with `prepend` or `append`
- Check if the directory actually exists: `"/path" | path exists`

**Errors on startup:**
- Nushell is strict about syntax errors
- Check for typos in `~/.shell_integrations.nu`
- Comment out sections to isolate the problem

---

## Learning Resources

- [Nushell Book](https://www.nushell.sh/book/)
- [Nushell Configuration](https://www.nushell.sh/book/configuration.html)
- [Nushell Environment](https://www.nushell.sh/book/environment.html)
